! ------------------------------------------------------------------------------
! Copyright (C) 2009-2024 Mats Bentsen, Mariana Vertenstein
!
! This file is part of BLOM.
!
! BLOM is free software: you can redistribute it and/or modify it under the
! terms of the GNU Lesser General Public License as published by the Free
! Software Foundation, either version 3 of the License, or (at your option)
! any later version.
!
! BLOM is distributed in the hope that it will be useful, but WITHOUT ANY
! WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
! FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for
! more details.
!
! You should have received a copy of the GNU Lesser General Public License
! along with BLOM. If not, see <https://www.gnu.org/licenses/>.
! ------------------------------------------------------------------------------

module mod_chkvar
  ! ------------------------------------------------------------------------------
  ! This module contains variables and procedures related to tidal wave energy
  ! dissipation.
  ! ------------------------------------------------------------------------------

  use mod_types, only: r8
  use mod_xc
  use mod_state, only: dp, temp, saln

  implicit none

  private

  public :: chkvar

contains

  ! ---------------------------------------------------------------------------
  ! Private procedures.
  ! ---------------------------------------------------------------------------

  pure logical function isnan(a)
  ! ---------------------------------------------------------------------------
  ! Check if a real(r8) number is NaN.
  ! ---------------------------------------------------------------------------

    real(r8), intent(in) :: a

    if (a /= a) then
      isnan = .true.
    else
      isnan = .false.
    endif

  end function isnan


  pure logical function isinf(a)
  ! ---------------------------------------------------------------------------
  ! Check if a real(r8) number is Inf.
  ! ---------------------------------------------------------------------------

    real(r8), intent(in) :: a

    if ((a*0) /= 0) then
      isinf = .true.
    else
      isinf = .false.
    endif

  end function isinf

  ! ---------------------------------------------------------------------------
  ! Public procedures.
  ! ---------------------------------------------------------------------------

  subroutine chkvar(m, n, mm, nn, k1m, k1n)
  ! ---------------------------------------------------------------------------
  ! Check for NaN of Inf in layer thickness, temperature and salinity
  ! variables.
  ! ---------------------------------------------------------------------------

    integer, intent(in) :: m, n, mm, nn, k1m, k1n

    integer :: i, j, k, l, kn

    !$omp parallel do private(k, kn, l, i)
    do j = 1, jj
      do k = 1, kk
        kn = k + nn
        do l = 1, isp(j)
          do i = max(1, ifp(j, l)), min(ii, ilp(j, l))
            if (isnan(dp(i, j, kn))) then
              write (lp,'(a, i4, a, i4, a, i4, a)') &
                   ' chkvar: dp is NaN at (i =', i0 + i,', j =', j0 + j, &
                   ', k =', k,')'
              call xchalt('(chkvar')
              stop '(chkvar)'
            endif
            if (isinf(dp(i, j, kn))) then
              write (lp,'(a, i4, a, i4, a, i4, a)') &
                   ' chkvar: dp is Inf at (i =', i0 + i,', j =', j0 + j, &
                   ', k =', k,')'
              call xchalt('(chkvar')
              stop '(chkvar)'
            endif
            if (isnan(temp(i, j, kn))) then
              write (lp,'(a, i4, a, i4, a, i4, a)') &
                   ' chkvar: temp is NaN at (i =', i0 + i,', j =', j0 + j, &
                   ', k =', k,')'
              call xchalt('(chkvar')
              stop '(chkvar)'
            endif
            if (isinf(temp(i, j, kn))) then
              write (lp,'(a, i4, a, i4, a, i4, a)') &
                   ' chkvar: temp is Inf at (i =', i0 + i,', j =', j0 + j, &
                   ', k =', k,')'
              call xchalt('(chkvar')
              stop '(chkvar)'
            endif
            if (isnan(saln(i, j, kn))) then
              write (lp,'(a, i4, a, i4, a, i4, a)') &
                   ' chkvar: saln is NaN at (i =', i0 + i,', j =', j0 + j, &
                   ', k =', k,')'
              call xchalt('(chkvar')
              stop '(chkvar)'
            endif
            if (isinf(saln(i, j, kn))) then
              write (lp,'(a, i4, a, i4, a, i4, a)') &
                   ' chkvar: saln is Inf at (i =', i0 + i,', j =', j0 + j, &
                   ', k =', k,')'
              call xchalt('(chkvar')
              stop '(chkvar)'
            endif
          enddo
        enddo
      enddo
    enddo
    !$omp end parallel do

  end subroutine chkvar

end module mod_chkvar
